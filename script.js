
(() => {
  try{Object.defineProperty(window,"__DEVTOOLS__",{"get":function(){throw new Error("ðŸ™…â€â™‚ï¸");},configurable:!0});}catch(_){}
  const _X=(f,...a)=>{try{return f(...a)}catch(e){return void 0}},_E=(s)=>encodeURIComponent(s),_T=(n,d=2)=> (n==null||n===''||!Number.isFinite(Number(n)))?"â€”":Number(n).toLocaleString('en-IN',{maximumFractionDigits:d,minimumFractionDigits:d}),_P=(p)=>{const n=Number(p);if(!Number.isFinite(n))return"â€”";const s=n>=0?"+":"";return s+n.toFixed(2)+"%";},_N=(k)=>String(k||"").replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toLowerCase(),_G=(x)=>{if(x==null)return NaN;const s=String(x).trim();if(!s)return NaN;const c=s.replace(/[,%\s]/g,"");const n=Number(c);return Number.isFinite(n)?n:NaN},_D=(t)=>{const r=[],e=[],n='';let o='',q=!1;for(let i=0;i<t.length;i++){const c=t[i];if(q){if(c=='"'){if(t[i+1]=='"'){o+='"';i++;}else q=!1;}else o+=c;}else{if(c=='"')q=!0;else if(c==','){e.push(o);o='';}else if(c=='\n'){e.push(o);r.push(e.slice());e.length=0;o='';}else if(c!='\r')o+=c;}}if(o.length>0||e.length>0){e.push(o);r.push(e);}return r},_H=(id)=>document.getElementById(id),_a=(r,c)=>{const m=new Map();Object.keys(r||{}).forEach(k=>m.set(_N(k),r[k]));for(const cand of c){const v=m.get(_N(cand));if(v!=null&&String(v).trim()!=='')return v;}const want=_N(c[0]||'');for(const [k,v] of m){if(k.includes(want)&&String(v).trim()!=='')return v;}},_b=(pct)=>{const v=Number(pct);if(!Number.isFinite(v))return'#f4f4f5';const c=Math.max(-3,Math.min(3,v));const t=(c+3)/6;const r=Math.round(251*(1-t)+230*t),g=Math.round(234*(1-t)+246*t),b=Math.round(234*(1-t)+230*t);return `rgb(${r},${g},${b})`;},_s=(vals)=>{if(!vals||!vals.length)return'';const nums=vals.map(v=>_G(v)).filter(Number.isFinite);if(!nums.length)return'';const w=100,h=30,p=2,min=Math.min(...nums),max=Math.max(...nums),span=(max-min)||1;return nums.map((v,i)=>{const x=(i/(nums.length-1))*w,y=h-p-((v-min)/span)*(h-2*p);return (i?' L':'M')+x.toFixed(2)+','+y.toFixed(2)}).join('')},_c=(el,val)=>{const n=Number(val);if(!el)return; if(!Number.isFinite(n)){el.textContent="â€”";el.style.background='rgba(107,114,128,.12)';el.style.color='#374151';return;} el.textContent=_P(n);el.style.background=n>=0?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)';el.style.color=n>=0?'#16a34a':'#dc2626';};

  const SHEET_ID = ['1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg'].join('');

 
  const DEMO = {headlinesTop:["Infosys & Airtel firm; HDFC Bank soft","Reliance modestly green; autos mixed","IT steady; VIX subdued"],headlinesBottom:["PSUs mixed; energy heavyweights stable","Broader market outperforms; mid/small +0.8%"],indices:[{Name:"Nifty 50",Value:"24,980",ChangePct:"0.42",Spark:"24810,24855,24900,24960,24930,24980"},{Name:"Sensex",Value:"81,644",ChangePct:"0.46",Spark:"81400,81450,81600,81680,81620,81644"},{Name:"Bank Nifty",Value:"51,900",ChangePct:"0.30",Spark:"51700,51760,51820,51920,51860,51900"},{Name:"Nifty IT",Value:"43,300",ChangePct:"0.55",Spark:"43100,43180,43240,43340,43290,43300"}],heatmap:[{Label:"RELI",ChangePct:"0.6"},{Label:"HDFB",ChangePct:"-0.4"},{Label:"INFY",ChangePct:"0.7"},{Label:"TCS",ChangePct:"0.3"},{Label:"SBIN",ChangePct:"-0.2"},{Label:"ITC",ChangePct:"0.1"}],commodities:[{Name:"WTI Crude ($)",Last:"61.90",Change:"-0.40",Pct:"-0.64"},{Name:"Brent ($)",Last:"65.10",Change:"-0.35",Pct:"-0.53"},{Name:"Gold ($/oz)",Last:"3387.00",Change:"5.00",Pct:"0.15"}]};

  // ====== LOCAL ARTICLES ======
  const ARTICLES = [
    {
      href: "ia-ra-deposit-liquid-overnight-mf-how-to.html",
      title: "IA/RA Compliance Hack â€” Deposits via Liquid/Overnight MFs: Cashflow Relief, Risks & How-To",
      blurb: "SEBI lets RA/IA deposits sit in liquid/overnight MFsâ€”cashflow relief, risks, and a practical how-to."
    },
    {
      href: "t0-optional-margin-pledge-extension-retail-two-speed.html",
      title: "T+0 (Optional) & Pledge Extension: Two-Speed Retail Should Navigate",
      blurb: "Same-day pledge/withdrawal basics, collateral haircuts, broker ops, and how funding costs shift for small investors."
    }
  ];

  const _u=(s,r)=>`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${_E(s)}&range=${_E(r)}&t=${Date.now()}`;
  const _f=async(s,r)=>{try{const res=await fetch(_u(s,r),{cache:"no-store"});if(!res.ok)throw new Error(`HTTP ${res.status}`);const txt=await res.text();if(txt.trim().startsWith('<')){console.warn("[Sheets]",s,": HTML (private?). Using fallback.");return null;}const rows=_D(txt);if(!rows.length)return[];const headers=rows[0].map(h=>h.replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim());return rows.slice(1).filter(r=>r.some(x=>(x??'').toString().trim()!=='')).map(r=>Object.fromEntries(headers.map((h,i)=>[h,(r[i]??'').toString().trim()])));}catch(err){console.error("[Sheets]",s,"failed:",err);return null;}};

  const _rt=(id,items,dir='right')=>{const el=_H(id);if(!el)return;el.className=(dir==='right'?'ticker-right':'ticker-left')+" text-sm font-medium space-x-10";el.innerHTML='';const loop=[...items,...items];for(const t of loop){const s=document.createElement('span');s.textContent=t;el.appendChild(s);}},_ri=(arr)=>{const grid=_H('indicesGrid');if(!grid)return;grid.innerHTML='';arr.forEach((x,i)=>{const name=_a(x,['Name']);const value=_G(_a(x,['Value']));const chg=_G(_a(x,['ChangePct']));let sv=[];const raw=_a(x,['Spark']);if(raw)sv=String(raw).split(',').map(s=>s.trim());else{const keys=Object.keys(x).filter(k=>/^s\d+$/i.test(_N(k))).sort((a,b)=>Number(_N(a).slice(1))-Number(_N(b).slice(1)));sv=keys.map(k=>x[k]).filter(Boolean);}const wrap=document.createElement('div');wrap.innerHTML=`<div class="card"><div class="flex items-center justify-between"><p class="text-sm text-gray-600">${name||'â€”'}</p><span id="chg-${i}" class="text-xs font-semibold px-2 py-0.5 rounded">â€”</span></div><p class="text-2xl font-bold mt-1">${_T(value,2)}</p><svg class="spark w-full h-12 mt-2" viewBox="0 0 100 30" preserveAspectRatio="none"><path id="spark-${i}" d=""/></svg></div>`;grid.appendChild(wrap.firstElementChild);_c(_H(`chg-${i}`),chg);const p=_H(`spark-${i}`);if(p){p.setAttribute('d',_s(sv));p.setAttribute('stroke',(Number.isFinite(chg)&&chg>=0)?'#16a34a':'#dc2626');}});},_rh=(rows)=>{const grid=_H('heatmapGrid');if(!grid)return;grid.innerHTML='';rows.forEach(t=>{const label=_a(t,['Label']);const pct=_G(_a(t,['ChangePct']));const a=document.createElement('div');a.className='heat-tile';a.style.background=_b(pct);const color=(Number.isFinite(pct)&&pct>=0)?'#16a34a':'#dc2626';a.innerHTML=`${label||'â€”'}<br><span class="text-xs text-gray-700 font-normal" style="color:${Number.isFinite(pct)?color:'#6b7280'}">${_P(pct)}</span>`;grid.appendChild(a);});},_rc=(rows)=>{const tbody=_H('commoditiesBody');if(!tbody)return;tbody.innerHTML='';rows.forEach((row,i)=>{const name=_a(row,['Name','Instrument','Commodity','Label'])||`Item ${i+1}`;const last=_G(_a(row,['Last','Price','Close','Value']));const chg=_G(_a(row,['Change','Chg']));const pct=_G(_a(row,['Pct','PctChg','%Chg','Percent','Change%']));const tr=document.createElement('tr');tr.innerHTML=`<td class="px-4 py-3">${name}</td><td class="px-4 py-3 text-right">${_T(last,2)}</td><td class="px-4 py-3 text-right ${(Number.isFinite(chg)&&chg>=0)?'text-green-600':'text-red-600'}">${(Number.isFinite(chg)&&chg>=0?'+':'')+_T(chg,2)}</td><td class="px-4 py-3 text-right ${(Number.isFinite(pct)&&pct>=0)?'text-green-600':'text-red-600'}">${_P(pct)}</td>`;tbody.appendChild(tr);});},_ra=(rows)=>{const box=_H('articlesList');if(!box)return;box.innerHTML='';rows.forEach(a=>{const href=a.href||a.Href,title=a.title||a.Title,blurb=a.blurb||a.Blurb;const el=document.createElement('a');el.href=href;el.className='block border rounded-xl p-5 shadow-sm hover:shadow-md transition space-y-1';el.innerHTML=`<h3 class="text-lg font-semibold">${title}</h3><p class="text-sm text-gray-600">${blurb}</p>`;box.appendChild(el);});};

 
  const _SCRIPT="https://script.google.com/macros/s/AKfycbwT4FQr2Qb91fiqEgeUQMdnD5dDACtWyFnktA5MUp8sHHVebvFIOq4k3yMGKqJmlPJ_MA/exec";
  function subscribeUser(e){try{e&&e.preventDefault&&e.preventDefault();const i=_H('emailInput'),m=_H('subscribeMessage'),er=_H('errorMessage');if(!i)return;const email=i.value,f=new FormData();f.append("email",email);fetch(_SCRIPT,{method:"POST",body:f}).then(r=>r.text()).then(t=>{const ok=(t||'').toLowerCase();if(m&&er){if(ok.includes('success')){m.textContent="âœ… Subscribed successfully!";m.classList.remove('hidden');er.classList.add('hidden');}else if(ok.includes('already')){m.textContent="âš ï¸ You're already subscribed.";m.classList.remove('hidden');er.classList.add('hidden');}else throw new Error(t);}const form=e&&e.target;if(form&&form.reset)form.reset();}).catch(()=>{er&&er.classList.remove('hidden');m&&m.classList.add('hidden');});}catch(_){}}
  window.subscribeUser = subscribeUser;

  const _hydrate=async()=>{try{console.info("[bataSutra] Hydrating from Sheetsâ€¦");const H=await _f('Headlines','A:B');if(H===null){_rt('topTicker',DEMO.headlinesTop,'right');_rt('bottomTicker',DEMO.headlinesBottom,'left');}else{const top=(H||[]).filter(h=>/^top$/i.test((h.Section||'').toString())).map(h=>h.Text),bottom=(H||[]).filter(h=>/^bottom$/i.test((h.Section||'').toString())).map(h=>h.Text);_rt('topTicker',top.length?top:DEMO.headlinesTop,'right');_rt('bottomTicker',bottom.length?bottom:DEMO.headlinesBottom,'left');}const I=await _f('Indices','A:Z');_ri(I===null||I.length===0?DEMO.indices:I);const HM=await _f('Heatmap','A:B');_rh(HM===null||HM.length===0?DEMO.heatmap:HM);const C=await _f('Commodities','A1:D');_rc(C===null||C.length===0?DEMO.commodities:C);console.info("[bataSutra] Hydration done.");}catch(e){console.error(e)}};

 
  window.addEventListener('DOMContentLoaded',()=>{try{console.info("[bataSutra] DOM ready.");const y=_H('year');if(y)y.textContent=(new Date).getFullYear();document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show'));document.querySelectorAll('.spark path').forEach(p=>p.setAttribute('stroke','#4b5563'));_ra(ARTICLES);const form=document.querySelector('form[onsubmit*="subscribeUser"]')||document.querySelector('form');if(form&&!form.__wired){form.addEventListener('submit',subscribeUser);form.__wired=!0;}if(location.protocol==='file:'){console.warn("You are opening via file:// â€” use a local server if Sheets requests fail.");}_hydrate().catch(console.error);setInterval(()=>_hydrate().catch(console.error),300000);}catch(e){}});

  
  setInterval(()=>{try{void Function("")()}catch(_){/* noop */}},5000);
})();
